<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Simple Phase 4 Test</title>
</head>
<body>
    <h1>Simple Phase 4 Test</h1>
    <div id="result"></div>
    <button onclick="testFunctions()">함수 테스트</button>

    <script>
        function testFunctions() {
            const result = document.getElementById('result');
            const status = {
                APP_CONFIG: typeof window.APP_CONFIG,
                ensureAppsScriptUrl: typeof window.ensureAppsScriptUrl,
                protectedApiCall: typeof window.protectedApiCall,
                ApiCallManager: typeof window.ApiCallManager,
                getUserFriendlyErrorMessage: typeof window.getUserFriendlyErrorMessage
            };

            result.innerHTML = `
                <h3>함수 정의 상태:</h3>
                <ul>
                    <li>APP_CONFIG: ${status.APP_CONFIG}</li>
                    <li>ensureAppsScriptUrl: ${status.ensureAppsScriptUrl}</li>
                    <li>protectedApiCall: ${status.protectedApiCall}</li>
                    <li>ApiCallManager: ${status.ApiCallManager}</li>
                    <li>getUserFriendlyErrorMessage: ${status.getUserFriendlyErrorMessage}</li>
                </ul>
            `;

            console.log('함수 상태:', status);
        }

        // 페이지 로드 시 자동 실행
        window.addEventListener('load', testFunctions);
    </script>

    <!-- 메인 스크립트 내용을 직접 복사해서 테스트 -->
    <script>
        console.log('Phase 4 함수 직접 정의 시작...');

        // APP_CONFIG 정의
        window.APP_CONFIG = {
            isInitialized: false,
            appsScriptUrl: null,
            autoInit: false,
            version: '3.4.24',
            data: {},
            settings: { debugMode: false, autoSave: true, offlineMode: false },
            state: { lastConnection: null, connectionAttempts: 0, isOnline: navigator.onLine }
        };

        // validateAppsScriptUrl 함수 정의
        function validateAppsScriptUrl(url) {
            if (!url || typeof url !== 'string') return false;
            // Google Apps Script URL 패턴 검증
            return /^https:\/\/script\.google\.com\/macros\/s\/[A-Za-z0-9_-]+\/exec$/.test(url);
        }

        // Phase 4 함수들 정의
        window.ensureAppsScriptUrl = function() {
            console.log('ensureAppsScriptUrl 호출됨');
            if (!window.APP_CONFIG.appsScriptUrl) {
                throw new Error('Apps Script URL이 설정되지 않았습니다. 설정 화면에서 URL을 입력하세요.');
            }

            if (!validateAppsScriptUrl(window.APP_CONFIG.appsScriptUrl)) {
                throw new Error('올바르지 않은 Apps Script URL입니다. 설정을 다시 확인하세요.');
            }

            if (!window.APP_CONFIG.isInitialized) {
                throw new Error('앱이 초기화되지 않았습니다. 먼저 초기화를 완료하세요.');
            }

            if (!window.APP_CONFIG.state.isOnline) {
                throw new Error('인터넷 연결이 끊어졌습니다. 네트워크 상태를 확인하세요.');
            }

            return window.APP_CONFIG.appsScriptUrl;
        };

        window.protectedApiCall = async function(action, data = {}, options = {}) {
            console.log('protectedApiCall 호출됨:', action, data, options);
            return { success: true, message: 'Test API call', data };
        };

        window.ApiCallManager = {
            calls: [],
            addCall: function(call) {
                this.calls.push(call);
            },
            getStats: function() {
                return {
                    totalCalls: this.calls.length,
                    successCalls: 0,
                    failedCalls: 0,
                    averageResponseTime: 0
                };
            }
        };

        window.getUserFriendlyErrorMessage = function(error, action) {
            console.log('getUserFriendlyErrorMessage 호출됨:', error, action);
            return '사용자 친화적 에러 메시지';
        };

        console.log('Phase 4 함수 정의 완료');
        console.log('APP_CONFIG:', typeof window.APP_CONFIG);
        console.log('ensureAppsScriptUrl:', typeof window.ensureAppsScriptUrl);
        console.log('protectedApiCall:', typeof window.protectedApiCall);
        console.log('ApiCallManager:', typeof window.ApiCallManager);
        console.log('getUserFriendlyErrorMessage:', typeof window.getUserFriendlyErrorMessage);

        // 즉시 테스트
        setTimeout(testFunctions, 100);
    </script>
</body>
</html>