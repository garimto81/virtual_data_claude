<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Virtual 시트 18:41 매칭 테스트</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
    button { padding: 10px 20px; background: #333; color: #0f0; border: 1px solid #0f0; cursor: pointer; }
    #results { margin-top: 20px; white-space: pre-wrap; border: 1px solid #0f0; padding: 10px; min-height: 300px; }
    .match { background: #003300; padding: 5px; margin: 5px 0; }
    .close { background: #333300; padding: 5px; margin: 5px 0; }
  </style>
</head>
<body>
  <h1>Virtual 시트 18:41 직접 테스트</h1>
  
  <div>
    <p>공개 URL: https://docs.google.com/spreadsheets/d/e/2PACX-1vTq3wrZNUASAMxl9A6VvJxTT6DKj40xp0R2xcIGfeji6MxQ8wi6Zbu_FWPmxKkmJdPHYgMC6UIT9tvv/pub?gid=561799849&single=true&output=csv</p>
    <button onclick="testVirtualSheet()">18:41 찾기</button>
  </div>
  
  <div id="results"></div>
  
  <script>
    const resultsDiv = document.getElementById('results');
    
    function log(msg, className = '') {
      resultsDiv.innerHTML += `<div class="${className}">${msg}</div>`;
    }
    
    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      return lines.map(line => {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          const next = line[i + 1];
          
          if (char === '"' && inQuotes && next === '"') {
            current += '"';
            i++;
          } else if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current);
        return result;
      });
    }
    
    async function testVirtualSheet() {
      resultsDiv.innerHTML = '';
      
      const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTq3wrZNUASAMxl9A6VvJxTT6DKj40xp0R2xcIGfeji6MxQ8wi6Zbu_FWPmxKkmJdPHYgMC6UIT9tvv/pub?gid=561799849&single=true&output=csv';
      
      log('🔍 Virtual 시트 접근 중...');
      log('📊 목표 시간: 18:41\n');
      
      try {
        const response = await fetch(csvUrl);
        const text = await response.text();
        
        // 처음 1000자 확인
        log('📄 응답 데이터 처음 1000자:');
        log(text.substring(0, 1000));
        log('\n' + '='.repeat(70) + '\n');
        
        // HTML 체크
        if (text.includes('<html') || text.includes('<HTML')) {
          log('❌ HTML 응답 감지. CSV가 아닙니다.\n');
          
          // 대체 URL 시도
          const altUrl = 'https://docs.google.com/spreadsheets/d/1M-LM2KkwLNOTygtrPVdnYLqqBoz4MmZvbglUaptSYqE/gviz/tq?tqx=out:csv&sheet=Virtual&gid=561799849';
          log('🔄 대체 URL 시도: ' + altUrl.substring(0, 80) + '...\n');
          
          const altResponse = await fetch(altUrl);
          const altText = await altResponse.text();
          
          if (altText.includes('<html') || altText.includes('<HTML')) {
            log('❌ 대체 URL도 실패. 시트 권한 확인 필요.\n');
            log('\n💡 해결 방법:');
            log('1. Google Sheets에서 파일 > 공유 > "링크가 있는 모든 사용자"');
            log('2. 보기 권한 이상 설정');
            log('3. 웹에 게시 옵션 사용');
            return;
          }
          
          processCSV(altText);
        } else {
          processCSV(text);
        }
        
      } catch (error) {
        log(`❌ 오류: ${error.message}`);
      }
    }
    
    function processCSV(text) {
      const rows = parseCSV(text);
      log(`✅ CSV 파싱 성공: ${rows.length}개 행\n`);
      
      if (rows.length === 0) {
        log('❌ 데이터가 없습니다');
        return;
      }
      
      // 헤더 확인
      log('📋 헤더:');
      const headers = rows[0].slice(0, 8);
      headers.forEach((h, i) => {
        log(`  ${String.fromCharCode(65 + i)}열: "${h}"`);
      });
      log('');
      
      // C열 샘플
      log('📊 C열 시간 데이터 (처음 20개):');
      for (let i = 1; i < Math.min(21, rows.length); i++) {
        const cValue = rows[i][2];
        if (cValue && cValue.trim()) {
          log(`  행 ${i + 1}: "${cValue}"`);
        }
      }
      log('');
      
      // 18:41 찾기
      const targetHours = 18;
      const targetMinutes = 41;
      const targetTotalMinutes = targetHours * 60 + targetMinutes;
      
      log('🎯 18:41 매칭 검색...\n');
      
      const matches = [];
      const closeMatches = [];
      
      for (let i = 1; i < rows.length; i++) {
        const cValue = rows[i][2];
        if (!cValue) continue;
        
        // 시간 파싱
        const timeMatch = cValue.match(/(\d{1,2}):(\d{2})/);
        if (timeMatch) {
          const hours = parseInt(timeMatch[1]);
          const minutes = parseInt(timeMatch[2]);
          const totalMinutes = hours * 60 + minutes;
          const diff = Math.abs(totalMinutes - targetTotalMinutes);
          
          if (diff === 0) {
            matches.push(i + 1);
            log(`✅ 정확히 일치! 행 ${i + 1}: "${cValue}"`, 'match');
            log(`   A열: "${rows[i][0]}" | B열: "${rows[i][1]}"`, 'match');
          } else if (diff <= 5) {
            closeMatches.push({
              row: i + 1,
              time: cValue,
              diff: diff
            });
          }
        }
      }
      
      if (matches.length > 0) {
        log(`\n✅ 총 ${matches.length}개 행이 18:41과 정확히 일치`, 'match');
      } else {
        log('\n❌ 18:41과 정확히 일치하는 행 없음');
        
        if (closeMatches.length > 0) {
          log('\n⚠️ 근접한 시간:', 'close');
          closeMatches.sort((a, b) => a.diff - b.diff);
          closeMatches.slice(0, 5).forEach(m => {
            log(`  행 ${m.row}: ${m.time} (${m.diff}분 차이)`, 'close');
          });
        }
      }
    }
  </script>
</body>
</html>