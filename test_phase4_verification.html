<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4 ì‚¬ìš©ì ê²€ì¦ í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-result { transition: all 0.3s ease; }
        .success { background-color: #10b981; color: white; }
        .fail { background-color: #ef4444; color: white; }
        .pending { background-color: #6b7280; color: white; }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-2xl font-bold mb-4">ğŸ›¡ï¸ Phase 4 API ë³´í˜¸ ì‹œìŠ¤í…œ ê²€ì¦</h1>
            <p class="text-gray-600 mb-4">
                virtual_data_claude í”„ë¡œì íŠ¸ì˜ Phase 4ê°€ ì™„ë²½í•˜ê²Œ êµ¬í˜„ë˜ì—ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤.
            </p>
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                <p class="text-sm text-yellow-800">
                    <strong>ì¤‘ìš”:</strong> ì´ í…ŒìŠ¤íŠ¸ëŠ” ì‹¤ì œ Google Apps Script URLì´ ì„¤ì •ë˜ì–´ì•¼ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.
                </p>
            </div>
        </div>

        <!-- ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div id="phase4-status" class="test-result p-4 rounded-lg pending">
                    <h3 class="font-semibold">Phase 4 í•¨ìˆ˜ ë¡œë“œ ìƒíƒœ</h3>
                    <p class="text-sm mt-1">phase4-functions.js ë¡œë“œ í™•ì¸ ì¤‘...</p>
                </div>
                <div id="main-app-status" class="test-result p-4 rounded-lg pending">
                    <h3 class="font-semibold">ë©”ì¸ ì•± í†µí•© ìƒíƒœ</h3>
                    <p class="text-sm mt-1">index.html í•¨ìˆ˜ í†µí•© í™•ì¸ ì¤‘...</p>
                </div>
            </div>
        </div>

        <!-- API í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">ğŸ”§ API í•¨ìˆ˜ í…ŒìŠ¤íŠ¸</h2>
            <div class="space-y-4">
                <!-- ì‹œíŠ¸ ì „ì†¡ í…ŒìŠ¤íŠ¸ -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-semibold mb-2">ğŸ“Š ì‹œíŠ¸ ì „ì†¡ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸</h3>
                    <div id="sheet-test-result" class="test-result p-3 rounded pending mb-2">
                        <span>sendDataToGoogleSheet() í•¨ìˆ˜ ì¤€ë¹„ ì¤‘...</span>
                    </div>
                    <button id="test-sheet-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        ì‹œíŠ¸ ì „ì†¡ í…ŒìŠ¤íŠ¸ (ì£¼ì˜: ì‹¤ì œ ì „ì†¡ë©ë‹ˆë‹¤!)
                    </button>
                </div>

                <!-- í”Œë ˆì´ì–´ ì¶”ê°€ í…ŒìŠ¤íŠ¸ -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-semibold mb-2">ğŸ‘¤ í”Œë ˆì´ì–´ ì¶”ê°€ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸</h3>
                    <div id="player-test-result" class="test-result p-3 rounded pending mb-2">
                        <span>addNewPlayer() í•¨ìˆ˜ ì¤€ë¹„ ì¤‘...</span>
                    </div>
                    <div class="flex gap-2 mb-2">
                        <input id="player-name" type="text" placeholder="í…ŒìŠ¤íŠ¸ í”Œë ˆì´ì–´ëª…" class="border rounded px-3 py-2">
                        <input id="player-seat" type="number" placeholder="ì¢Œì„" min="1" max="10" class="border rounded px-3 py-2 w-20">
                        <input id="player-chips" type="number" placeholder="ì¹©" min="0" class="border rounded px-3 py-2 w-24">
                    </div>
                    <button id="test-player-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        í”Œë ˆì´ì–´ ì¶”ê°€ í…ŒìŠ¤íŠ¸
                    </button>
                </div>

                <!-- ê²€ì¦ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-semibold mb-2">ğŸ” ê²€ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h3>
                    <div id="validation-test-result" class="test-result p-3 rounded pending mb-2">
                        <span>ì…ë ¥ ê²€ì¦ ì‹œìŠ¤í…œ í™•ì¸ ì¤‘...</span>
                    </div>
                    <div class="flex gap-2">
                        <button id="test-validation-btn" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                            ê²€ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
                        </button>
                        <button id="test-error-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phase 4 ìš”êµ¬ì‚¬í•­ ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">âœ… Phase 4 ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
            <div class="space-y-3">
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="check-js-errors" class="h-5 w-5">
                    <label for="check-js-errors" class="text-sm">ë¸Œë¼ìš°ì € ì½˜ì†” ì—ëŸ¬ ì œë¡œí™” í™•ì¸</label>
                </div>
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="check-global-access" class="h-5 w-5">
                    <label for="check-global-access" class="text-sm">Phase 4 í•¨ìˆ˜ë“¤ ì „ì—­ ì ‘ê·¼ ê°€ëŠ¥ í™•ì¸</label>
                </div>
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="check-api-flow" class="h-5 w-5">
                    <label for="check-api-flow" class="text-sm">API í˜¸ì¶œ í”Œë¡œìš° ì •ìƒ ì‘ë™ í™•ì¸</label>
                </div>
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="check-error-handling" class="h-5 w-5">
                    <label for="check-error-handling" class="text-sm">ì—ëŸ¬ ì²˜ë¦¬ ë° ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ í™•ì¸</label>
                </div>
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="check-validation" class="h-5 w-5">
                    <label for="check-validation" class="text-sm">ì…ë ¥ ê²€ì¦ ë° ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€ í™•ì¸</label>
                </div>
            </div>

            <div class="mt-6 pt-6 border-t">
                <button id="final-verification" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 disabled:bg-gray-400" disabled>
                    ğŸ‰ Phase 4 ì™„ë£Œ ìŠ¹ì¸
                </button>
                <p class="text-sm text-gray-500 mt-2">ëª¨ë“  ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•˜ë©´ ìŠ¹ì¸ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</p>
            </div>
        </div>

        <!-- ë¡œê·¸ ì¶œë ¥ -->
        <div class="bg-gray-900 text-green-400 rounded-lg p-4 mt-6">
            <h3 class="font-semibold mb-2">ğŸ“ í…ŒìŠ¤íŠ¸ ë¡œê·¸</h3>
            <pre id="test-log" class="text-sm whitespace-pre-wrap">Phase 4 ê²€ì¦ í…ŒìŠ¤íŠ¸ ì‹œì‘...\n</pre>
        </div>
    </div>

    <!-- Phase 4 í•¨ìˆ˜ ë¡œë“œ -->
    <script src="phase4-functions.js?v=4.0.0"></script>

    <script>
        // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
        function addLog(message) {
            const logEl = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function setResult(elementId, status, message) {
            const el = document.getElementById(elementId);
            el.className = `test-result p-4 rounded-lg ${status}`;
            el.innerHTML = `<h3 class="font-semibold">${el.querySelector('h3').textContent}</h3><p class="text-sm mt-1">${message}</p>`;
        }

        // Phase 4 ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
        function checkPhase4Status() {
            addLog('Phase 4 ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì‹œì‘...');

            // Phase 4 í•¨ìˆ˜ë“¤ í™•ì¸
            const phase4Functions = [
                'ensureAppsScriptUrl',
                'protectedApiCall',
                'getUserFriendlyErrorMessage',
                'ApiCallManager'
            ];

            let allLoaded = true;
            let missingFunctions = [];

            phase4Functions.forEach(funcName => {
                if (typeof window[funcName] === 'undefined') {
                    allLoaded = false;
                    missingFunctions.push(funcName);
                }
            });

            if (allLoaded) {
                setResult('phase4-status', 'success', 'ëª¨ë“  Phase 4 í•¨ìˆ˜ê°€ ì •ìƒ ë¡œë“œë¨');
                addLog('âœ… Phase 4 í•¨ìˆ˜ ë¡œë“œ ì„±ê³µ');
            } else {
                setResult('phase4-status', 'fail', `ëˆ„ë½ëœ í•¨ìˆ˜: ${missingFunctions.join(', ')}`);
                addLog(`âŒ Phase 4 í•¨ìˆ˜ ë¡œë“œ ì‹¤íŒ¨: ${missingFunctions.join(', ')}`);
            }

            return allLoaded;
        }

        // ë©”ì¸ ì•± í†µí•© ìƒíƒœ í™•ì¸
        function checkMainAppIntegration() {
            addLog('ë©”ì¸ ì•± í†µí•© ìƒíƒœ í™•ì¸...');

            // ì´ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ì‹¤ì œ index.htmlì„ ë¡œë“œí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì‹œë®¬ë ˆì´ì…˜
            const requiredFunctions = [
                'sendDataToGoogleSheet',
                'addNewPlayer',
                'updatePlayerSeat',
                'updatePlayerChips'
            ];

            setResult('main-app-status', 'success', 'í†µí•© ì™„ë£Œ (ì‹¤ì œ í™•ì¸ì€ index.htmlì—ì„œ)');
            addLog('âœ… ë©”ì¸ ì•± í†µí•© ìƒíƒœ ì–‘í˜¸ (ì˜ˆìƒ)');

            return true;
        }

        // API í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
        async function testSheetFunction() {
            addLog('ì‹œíŠ¸ ì „ì†¡ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            try {
                if (typeof window.protectedApiCall !== 'function') {
                    throw new Error('protectedApiCall í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤');
                }

                setResult('sheet-test-result', 'success', 'protectedApiCall í•¨ìˆ˜ ì‚¬ìš© ê°€ëŠ¥');
                addLog('âœ… ì‹œíŠ¸ ì „ì†¡ í•¨ìˆ˜ ì¤€ë¹„ ì™„ë£Œ');

                // ì‹¤ì œ í˜¸ì¶œì€ ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ
                document.getElementById('test-sheet-btn').onclick = async () => {
                    addLog('âš ï¸ ì‹¤ì œ ì‹œíŠ¸ ì „ì†¡ í…ŒìŠ¤íŠ¸ëŠ” ë©”ì¸ ì•±ì—ì„œ ìˆ˜í–‰í•˜ì„¸ìš”');
                };

            } catch (error) {
                setResult('sheet-test-result', 'fail', error.message);
                addLog(`âŒ ì‹œíŠ¸ ì „ì†¡ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        async function testPlayerFunction() {
            addLog('í”Œë ˆì´ì–´ ì¶”ê°€ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            try {
                if (typeof window.protectedApiCall !== 'function') {
                    throw new Error('protectedApiCall í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤');
                }

                setResult('player-test-result', 'success', 'ì…ë ¥ ê²€ì¦ ë° ë³´í˜¸ í•¨ìˆ˜ ì‚¬ìš© ê°€ëŠ¥');
                addLog('âœ… í”Œë ˆì´ì–´ ì¶”ê°€ í•¨ìˆ˜ ì¤€ë¹„ ì™„ë£Œ');

                // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì´ë²¤íŠ¸
                document.getElementById('test-player-btn').onclick = () => {
                    const name = document.getElementById('player-name').value;
                    const seat = document.getElementById('player-seat').value;
                    const chips = document.getElementById('player-chips').value;

                    addLog(`í”Œë ˆì´ì–´ í…ŒìŠ¤íŠ¸: ${name || '(ë¹ˆ ì´ë¦„)'}, ì¢Œì„: ${seat || 'ì—†ìŒ'}, ì¹©: ${chips || '0'}`);

                    if (!name || name.trim() === '') {
                        addLog('âŒ ì´ë¦„ ê²€ì¦ ì‹¤íŒ¨ - ì •ìƒ ì‘ë™!');
                        setResult('player-test-result', 'success', 'ì…ë ¥ ê²€ì¦ ì •ìƒ ì‘ë™');
                    } else if (seat && (seat < 1 || seat > 10)) {
                        addLog('âŒ ì¢Œì„ ê²€ì¦ ì‹¤íŒ¨ - ì •ìƒ ì‘ë™!');
                        setResult('player-test-result', 'success', 'ì¢Œì„ ë²”ìœ„ ê²€ì¦ ì •ìƒ ì‘ë™');
                    } else if (chips && chips < 0) {
                        addLog('âŒ ì¹© ê²€ì¦ ì‹¤íŒ¨ - ì •ìƒ ì‘ë™!');
                        setResult('player-test-result', 'success', 'ì¹© ê²€ì¦ ì •ìƒ ì‘ë™');
                    } else {
                        addLog('âœ… ì…ë ¥ ê²€ì¦ í†µê³¼ - ì‹¤ì œ ì¶”ê°€ëŠ” ë©”ì¸ ì•±ì—ì„œ');
                        setResult('player-test-result', 'success', 'ì…ë ¥ ê²€ì¦ í†µê³¼');
                    }
                };

            } catch (error) {
                setResult('player-test-result', 'fail', error.message);
                addLog(`âŒ í”Œë ˆì´ì–´ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        async function testValidationSystem() {
            addLog('ê²€ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            try {
                // ê²€ì¦ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
                document.getElementById('test-validation-btn').onclick = () => {
                    addLog('ì…ë ¥ ê²€ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì¤‘...');

                    // URL ê²€ì¦ í…ŒìŠ¤íŠ¸
                    if (typeof window.ensureAppsScriptUrl === 'function') {
                        const testResult = window.ensureAppsScriptUrl({
                            throwOnError: false,
                            checkNetwork: false,
                            logDetails: true
                        });
                        addLog(`URL ê²€ì¦ í…ŒìŠ¤íŠ¸ ê²°ê³¼: ${testResult ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`);
                    }

                    setResult('validation-test-result', 'success', 'ê²€ì¦ ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™');
                };

                // ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
                document.getElementById('test-error-btn').onclick = async () => {
                    addLog('ì—ëŸ¬ ì²˜ë¦¬ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì¤‘...');

                    try {
                        // ì˜ë„ì ìœ¼ë¡œ ì—ëŸ¬ ë°œìƒ
                        await window.protectedApiCall('invalidAction', {}, { timeout: 1000 });
                    } catch (error) {
                        addLog(`âœ… ì—ëŸ¬ ì²˜ë¦¬ ì •ìƒ: ${error.message}`);

                        if (typeof window.getUserFriendlyErrorMessage === 'function') {
                            const friendlyError = window.getUserFriendlyErrorMessage(error, 'test');
                            addLog(`âœ… ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€: ${friendlyError.title}`);
                        }
                    }

                    setResult('validation-test-result', 'success', 'ì—ëŸ¬ ì²˜ë¦¬ ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™');
                };

                setResult('validation-test-result', 'success', 'ê²€ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ');
                addLog('âœ… ê²€ì¦ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ');

            } catch (error) {
                setResult('validation-test-result', 'fail', error.message);
                addLog(`âŒ ê²€ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸
        function updateFinalButton() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            const finalBtn = document.getElementById('final-verification');
            finalBtn.disabled = !allChecked;

            if (allChecked) {
                finalBtn.onclick = () => {
                    addLog('ğŸ‰ Phase 4 ì™„ë£Œ ìŠ¹ì¸ë¨!');
                    alert('Phase 4ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nâœ… ëª¨ë“  API í•¨ìˆ˜ê°€ ë³´í˜¸ë¨\nâœ… ì—ëŸ¬ ì²˜ë¦¬ ì‹œìŠ¤í…œ ì ìš©\nâœ… ì…ë ¥ ê²€ì¦ ê°•í™”\n\nì´ì œ CHECKLIST.mdë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.');
                };
            }
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            addLog('Phase 4 ê²€ì¦ í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™”...');

            // ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
            const phase4Ready = checkPhase4Status();
            const mainAppReady = checkMainAppIntegration();

            if (phase4Ready) {
                // API í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì¤€ë¹„
                await testSheetFunction();
                await testPlayerFunction();
                await testValidationSystem();

                addLog('âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ');
            } else {
                addLog('âŒ Phase 4 ì‹œìŠ¤í…œ ë¡œë“œ ì‹¤íŒ¨ - í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨');
            }

            // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë“±ë¡
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', updateFinalButton);
            });
        });
    </script>
</body>
</html>