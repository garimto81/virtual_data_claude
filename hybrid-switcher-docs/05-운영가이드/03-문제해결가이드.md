# 문제 해결 가이드

## 1. 문제 진단 체계

### 1.1 문제 분류
```
Level 1 - 경미한 문제 (운영자 해결 가능)
├── LED 표시 오류
├── 버튼 일시적 무반응
└── 화면 깜빡임

Level 2 - 중간 문제 (재시작 필요)
├── 서비스 응답 지연
├── 카메라 연결 끊김
└── 동기화 오류

Level 3 - 심각한 문제 (기술지원 필요)
├── 시스템 다운
├── 데이터 손실
└── 하드웨어 고장
```

### 1.2 진단 도구
```bash
# 시스템 상태 전체 진단
docker-compose exec backend npm run diagnose

# 특정 컴포넌트 진단
docker-compose exec backend npm run diagnose:hardware
docker-compose exec backend npm run diagnose:network
docker-compose exec backend npm run diagnose:database
```

## 2. 하드웨어 문제

### 2.1 LED 관련 문제

#### 문제: LED가 전혀 켜지지 않음
```
진단:
1. 전원 연결 확인
2. USB 연결 상태 확인
3. 디바이스 인식 확인: lsusb

해결:
1. USB 케이블 교체
2. 다른 USB 포트 사용
3. 컨트롤러 전원 사이클
4. 드라이버 재설치:
   sudo /opt/switcher/scripts/reinstall-drivers.sh
```

#### 문제: LED 색상이 잘못 표시됨
```
진단:
docker-compose exec backend npm run test:led --pattern=color-test

해결:
1. LED 매핑 설정 확인:
   cat /opt/switcher/config/led-mapping.json
2. 색상 캘리브레이션:
   docker-compose exec backend npm run calibrate:leds
3. 펌웨어 업데이트 확인
```

### 2.2 버튼 입력 문제

#### 문제: 특정 버튼만 작동하지 않음
```
진단:
1. 버튼 테스트 모드 실행
2. 입력 이벤트 모니터링:
   tail -f /var/log/switcher/input.log | grep "button_3"

해결:
1. 버튼 접점 청소
2. 디바운싱 시간 조정:
   {
     "debounceTime": 100  // ms
   }
3. 버튼 매핑 재설정
4. 하드웨어 교체 (최후 수단)
```

#### 문제: 더블 클릭/중복 입력 발생
```
진단:
입력 로그에서 중복 이벤트 확인

해결:
1. 디바운싱 설정 증가:
   docker-compose exec backend npm run config:set --key=input.debounce --value=150
2. 버튼 스위치 점검
3. 전기적 간섭 확인
```

## 3. 소프트웨어 문제

### 3.1 성능 저하

#### 문제: 시스템 응답 지연
```
진단:
1. 성능 메트릭 확인:
   curl http://localhost:9090/metrics | grep latency
2. 리소스 사용률 확인:
   docker stats

해결:
1. 캐시 정리:
   docker-compose exec redis redis-cli FLUSHALL
2. 서비스 재시작:
   docker-compose restart backend
3. 로그 레벨 조정 (디버그 모드 해제):
   export LOG_LEVEL=warn
4. 데이터베이스 인덱스 재구성:
   docker-compose exec postgres reindexdb -d switcher
```

#### 문제: 메모리 누수 의심
```
진단:
1. 메모리 사용 추이 확인
2. 힙 덤프 생성:
   docker-compose exec backend npm run heap-dump

해결:
1. 서비스 재시작 (임시)
2. 메모리 제한 설정:
   docker-compose.yml에서 mem_limit 조정
3. 가비지 컬렉션 강제 실행:
   docker-compose exec backend npm run gc
```

### 3.2 동기화 문제

#### 문제: 상태 불일치
```
증상:
- UI와 실제 상태가 다름
- LED 표시와 게임 상태 불일치

진단:
docker-compose exec backend npm run check:state-consistency

해결:
1. 강제 동기화:
   docker-compose exec backend npm run sync:force
2. 이벤트 버스 재시작:
   docker-compose restart rabbitmq
3. 상태 스냅샷 복원:
   docker-compose exec backend npm run state:restore --snapshot=latest
```

## 4. 네트워크 문제

### 4.1 연결 문제

#### 문제: 카메라 연결 실패
```
진단:
1. 네트워크 연결 테스트:
   ping [camera_ip]
2. 포트 스캔:
   nmap -p 554,5000-5100 [camera_ip]

해결:
1. 네트워크 설정 확인
2. 방화벽 규칙 확인:
   sudo iptables -L
3. 카메라 재부팅
4. 대체 프로토콜 사용:
   NDI → RTSP 전환
```

#### 문제: WebSocket 연결 끊김
```
진단:
1. 연결 로그 확인
2. 네트워크 지연 측정

해결:
1. Keep-alive 간격 조정:
   {
     "pingInterval": 25000,
     "pingTimeout": 5000
   }
2. 프록시 설정 확인
3. SSL 인증서 확인
```

### 4.2 대역폭 문제

#### 문제: 비디오 스트림 끊김
```
진단:
1. 네트워크 사용률 모니터링
2. 패킷 손실 확인:
   mtr [destination_ip]

해결:
1. 비디오 품질 조정
2. QoS 설정:
   - 스위처 트래픽 우선순위 설정
   - DSCP 마킹
3. 네트워크 분리:
   - 제어 트래픽과 미디어 트래픽 분리
```

## 5. 데이터베이스 문제

### 5.1 연결 문제

#### 문제: 데이터베이스 연결 실패
```
진단:
docker-compose exec backend npm run db:ping

해결:
1. PostgreSQL 서비스 확인:
   docker-compose ps postgres
2. 연결 문자열 확인
3. 연결 풀 재설정:
   docker-compose exec backend npm run db:reset-pool
4. 데이터베이스 재시작:
   docker-compose restart postgres
```

### 5.2 성능 문제

#### 문제: 쿼리 응답 지연
```
진단:
1. 느린 쿼리 확인:
   docker-compose exec postgres psql -c "SELECT * FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"

해결:
1. 인덱스 생성:
   CREATE INDEX idx_actions_timestamp ON actions(timestamp);
2. 통계 업데이트:
   ANALYZE;
3. 쿼리 최적화
4. 파티셔닝 고려
```

## 6. 비상 대응

### 6.1 시스템 전체 장애
```
즉시 조치:
1. 백업 시스템 활성화
2. 수동 운영 모드 전환
3. 최소 기능으로 방송 유지

복구 절차:
1. 장애 원인 파악
2. 데이터 무결성 확인
3. 단계별 서비스 재시작
4. 기능 검증 후 정상 운영 재개
```

### 6.2 데이터 복구
```bash
# 1. 최신 백업 확인
ls -la /backup/switcher/

# 2. 데이터베이스 복구
docker-compose exec postgres psql -U switcher -c "DROP DATABASE switcher;"
docker-compose exec postgres psql -U switcher -c "CREATE DATABASE switcher;"
docker-compose exec postgres psql -U switcher switcher < /backup/switcher/db_latest.sql

# 3. Redis 데이터 복구
docker-compose exec redis redis-cli FLUSHALL
docker-compose exec backend npm run cache:rebuild

# 4. 상태 검증
docker-compose exec backend npm run verify:data
```

## 7. 예방 조치

### 7.1 정기 점검 항목
```
일일 점검:
□ 시스템 로그 검토
□ 리소스 사용률 확인
□ 백업 상태 확인
□ 하드웨어 연결 상태

주간 점검:
□ 성능 트렌드 분석
□ 보안 업데이트 확인
□ 디스크 공간 정리
□ 네트워크 성능 테스트

월간 점검:
□ 전체 시스템 백업 테스트
□ 재해 복구 시뮬레이션
□ 하드웨어 예방 정비
□ 소프트웨어 업데이트
```

### 7.2 모니터링 알림 설정
```yaml
alerts:
  - name: high_latency
    condition: latency > 100ms
    duration: 5m
    action: email, slack
    
  - name: memory_usage
    condition: memory > 90%
    duration: 2m
    action: restart_service
    
  - name: connection_lost
    condition: device_disconnected
    duration: 30s
    action: page_operator
```

## 8. 지원 연락처

### 8.1 기술 지원
```
Level 1 Support (운영 시간 내):
- 전화: +82-2-1234-5678
- 이메일: support@switcher.example.com
- 응답 시간: 30분 이내

Level 2 Support (24/7):
- 긴급 전화: +82-2-1234-5679
- 긴급 이메일: emergency@switcher.example.com
- 응답 시간: 15분 이내

원격 지원:
- TeamViewer ID: 123 456 789
- AnyDesk ID: 987 654 321
```

### 8.2 하드웨어 벤더
```
제어 패널:
- 제조사: SwitcherTech Inc.
- 모델: ST-CP100
- 지원: hardware@switchertech.com

카메라 시스템:
- 제조사: ProVideo Systems
- 지원: support@provideo.com

오디오 시스템:
- 제조사: AudioPro Networks
- 지원: help@audiopro.net
```