<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4 External Script Test</title>
</head>
<body>
    <h1>Phase 4 External Script Test</h1>
    <div id="test-result"></div>
    <button onclick="testPhase4Functions()">Test Phase 4 Functions</button>

    <script>
        console.log('ğŸš€ External script test started');

        // APP_CONFIG ì •ì˜
        window.APP_CONFIG = {
            isInitialized: true,
            appsScriptUrl: 'https://script.google.com/macros/s/test123456789/exec',
            autoInit: false,
            version: '3.4.26',
            data: {},
            settings: { debugMode: true, autoSave: true, offlineMode: false },
            state: { lastConnection: null, connectionAttempts: 0, isOnline: navigator.onLine }
        };

        // fetchFromAppsScript ëª¨í‚¹ í•¨ìˆ˜
        window.fetchFromAppsScript = async function(action, data) {
            console.log('ğŸ“¡ Mock fetchFromAppsScript:', action, data);
            await new Promise(resolve => setTimeout(resolve, 100));
            return { success: true, action, data, timestamp: Date.now() };
        };

        // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        function testPhase4Functions() {
            console.log('ğŸ§ª Phase 4 External Functions í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            const results = {
                PHASE4_FUNCTIONS_LOADED: typeof window.PHASE4_FUNCTIONS_LOADED,
                APP_CONFIG: typeof window.APP_CONFIG,
                ensureAppsScriptUrl: typeof window.ensureAppsScriptUrl,
                protectedApiCall: typeof window.protectedApiCall,
                ApiCallManager: typeof window.ApiCallManager,
                getUserFriendlyErrorMessage: typeof window.getUserFriendlyErrorMessage,
                protectedSendToSheets: typeof window.protectedSendToSheets,
                protectedBulkRegister: typeof window.protectedBulkRegister,
                protectedAddPlayer: typeof window.protectedAddPlayer
            };

            console.log('ğŸ“Š í•¨ìˆ˜ ì •ì˜ ìƒíƒœ:', results);

            const resultDiv = document.getElementById('test-result');
            const allDefined = Object.entries(results).every(([name, type]) => {
                if (name === 'PHASE4_FUNCTIONS_LOADED') return type === 'boolean';
                return type === 'function' || type === 'object';
            });

            resultDiv.innerHTML = `
                <h3>í…ŒìŠ¤íŠ¸ ê²°ê³¼: ${allDefined ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'}</h3>
                <ul>
                    ${Object.entries(results).map(([name, type]) =>
                        `<li>${name}: ${type} ${
                            (name === 'PHASE4_FUNCTIONS_LOADED' && type === 'boolean') ||
                            (name !== 'PHASE4_FUNCTIONS_LOADED' && (type === 'function' || type === 'object'))
                            ? 'âœ…' : 'âŒ'
                        }</li>`
                    ).join('')}
                </ul>
            `;

            // ì‹¤ì œ í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
            if (allDefined) {
                console.log('ğŸ¯ í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸...');

                // URL ê²€ì¦ í…ŒìŠ¤íŠ¸
                try {
                    const url = window.ensureAppsScriptUrl();
                    console.log('âœ… URL ê²€ì¦ ì„±ê³µ:', url);
                } catch (error) {
                    console.log('âŒ URL ê²€ì¦ ì—ëŸ¬:', error.message);
                }

                // ì—ëŸ¬ ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸
                const errorMsg = window.getUserFriendlyErrorMessage(
                    new Error('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤'),
                    'testAction'
                );
                console.log('âœ… ì—ëŸ¬ ë©”ì‹œì§€ ìƒì„±:', errorMsg);

                // API Call Manager í…ŒìŠ¤íŠ¸
                const callId = window.ApiCallManager.startCall('testCall', { test: true });
                window.ApiCallManager.completeCall(callId, true, { result: 'success' });
                const stats = window.ApiCallManager.getCallStats();
                console.log('âœ… API Call Manager í†µê³„:', stats);

                // ë³´í˜¸ëœ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸ (ì‹¤ì œ í˜¸ì¶œ)
                window.protectedApiCall('test', { data: 'test' })
                    .then(result => {
                        console.log('âœ… ë³´í˜¸ëœ API í˜¸ì¶œ ì„±ê³µ:', result);
                    })
                    .catch(error => {
                        console.log('âŒ ë³´í˜¸ëœ API í˜¸ì¶œ ì‹¤íŒ¨:', error.message);
                    });
            }

            return allDefined;
        }

        // í˜ì´ì§€ ë¡œë“œ í›„ ìë™ í…ŒìŠ¤íŠ¸
        window.addEventListener('load', function() {
            console.log('âœ… í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            setTimeout(() => {
                if (window.PHASE4_FUNCTIONS_LOADED) {
                    testPhase4Functions();
                } else {
                    console.log('âŒ Phase 4 Functionsê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ');
                    document.getElementById('test-result').innerHTML =
                        '<p style="color: red;">âŒ Phase 4 Functions ë¡œë“œ ì‹¤íŒ¨</p>';
                }
            }, 100);
        });

        console.log('âœ… External test script completed');
    </script>

    <!-- Phase 4 Functions ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
    <script src="phase4-functions.js"></script>
</body>
</html>