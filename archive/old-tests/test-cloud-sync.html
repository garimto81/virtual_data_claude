<!DOCTYPE html>
<html>
<head>
  <title>Cloud Sync Test</title>
  <script src="https://cdn-tailwindcss.vercel.app/"></script>
</head>
<body class="bg-gray-900 text-white p-4">
  <h1 class="text-2xl mb-4">클라우드 동기화 테스트</h1>

  <!-- 테스트 UI -->
  <div class="bg-gray-800 p-4 rounded-lg max-w-md space-y-4">
    <!-- 기기 ID 표시 -->
    <div>
      <label class="block text-sm mb-2">기기 ID</label>
      <div id="device-id" class="bg-gray-700 p-2 rounded text-xs font-mono"></div>
    </div>

    <!-- URL 입력 -->
    <div>
      <label class="block text-sm mb-2">Apps Script URL</label>
      <input type="text" id="url-input"
             class="w-full bg-gray-700 p-2 rounded"
             placeholder="https://script.google.com/macros/s/.../exec">
    </div>

    <!-- 동기화 버튼들 -->
    <div class="flex space-x-2">
      <button id="save-to-cloud" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
        ☁️ 클라우드 저장
      </button>
      <button id="load-from-cloud" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
        ⬇️ 클라우드 로드
      </button>
    </div>

    <!-- 상태 표시 -->
    <div id="status" class="bg-gray-700 p-2 rounded text-sm"></div>
  </div>

  <script>
    // 기기 ID 생성 함수
    function generateDeviceId() {
      const id = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
      return id;
    }

    // 클라우드 설정
    const CLOUD_CONFIG = {
      gistApiUrl: 'https://api.github.com/gists',
      configGistId: localStorage.getItem('configGistId') || null,
      deviceId: localStorage.getItem('deviceId') || generateDeviceId()
    };

    // 기기 ID를 localStorage에 저장
    if (!localStorage.getItem('deviceId')) {
      localStorage.setItem('deviceId', CLOUD_CONFIG.deviceId);
    }

    // 상태 업데이트
    function updateStatus(message, isError = false) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = isError ?
        'bg-red-600 p-2 rounded text-sm' :
        'bg-green-600 p-2 rounded text-sm';
    }

    // 클라우드에 저장
    async function saveToCloud(url) {
      try {
        const config = {
          appsScriptUrl: url,
          deviceId: CLOUD_CONFIG.deviceId,
          lastUpdated: new Date().toISOString()
        };

        const gistData = {
          description: "Poker App Config",
          public: false,
          files: {
            "config.json": {
              content: JSON.stringify(config, null, 2)
            }
          }
        };

        let response;
        if (CLOUD_CONFIG.configGistId) {
          // 기존 Gist 업데이트
          response = await fetch(`${CLOUD_CONFIG.gistApiUrl}/${CLOUD_CONFIG.configGistId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(gistData)
          });
        } else {
          // 새 Gist 생성
          response = await fetch(CLOUD_CONFIG.gistApiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(gistData)
          });
        }

        if (response.ok) {
          const gist = await response.json();
          CLOUD_CONFIG.configGistId = gist.id;
          localStorage.setItem('configGistId', gist.id);
          updateStatus('✅ 클라우드에 저장 완료: ' + gist.id.substring(0, 8) + '...');
          return true;
        } else {
          throw new Error('HTTP ' + response.status);
        }
      } catch (error) {
        updateStatus('❌ 저장 실패: ' + error.message, true);
        return false;
      }
    }

    // 클라우드에서 로드
    async function loadFromCloud() {
      if (!CLOUD_CONFIG.configGistId) {
        updateStatus('❌ 저장된 클라우드 설정이 없습니다', true);
        return null;
      }

      try {
        const response = await fetch(`${CLOUD_CONFIG.gistApiUrl}/${CLOUD_CONFIG.configGistId}`);

        if (response.ok) {
          const gist = await response.json();
          const configContent = gist.files['config.json'].content;
          const config = JSON.parse(configContent);

          document.getElementById('url-input').value = config.appsScriptUrl || '';
          updateStatus('✅ 클라우드에서 로드 완료');
          return config;
        } else {
          throw new Error('HTTP ' + response.status);
        }
      } catch (error) {
        updateStatus('❌ 로드 실패: ' + error.message, true);
        return null;
      }
    }

    // 초기화
    document.addEventListener('DOMContentLoaded', () => {
      // 기기 ID 표시
      document.getElementById('device-id').textContent = CLOUD_CONFIG.deviceId;

      // 버튼 이벤트
      document.getElementById('save-to-cloud').addEventListener('click', async () => {
        const url = document.getElementById('url-input').value.trim();
        if (!url) {
          updateStatus('URL을 입력해주세요', true);
          return;
        }
        await saveToCloud(url);
      });

      document.getElementById('load-from-cloud').addEventListener('click', loadFromCloud);

      // 상태 초기화
      if (CLOUD_CONFIG.configGistId) {
        updateStatus('클라우드 연결됨: ' + CLOUD_CONFIG.configGistId.substring(0, 8) + '...');
      } else {
        updateStatus('클라우드 미연결 - URL을 저장하여 연결하세요');
      }
    });
  </script>
</body>
</html>