<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>Phase 1 테스트 - ActionHistory & 스낵바</title>
  <script src="https://cdn-tailwindcss.vercel.app/"></script>
  <script src="action-history.js"></script>
  <style>
    .snackbar {
      position: fixed;
      bottom: -60px;
      left: 10px;
      right: 10px;
      background: #333;
      color: white;
      padding: 12px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: bottom 0.2s ease-out;
      z-index: 10000;
      font-size: 14px;
      max-width: 500px;
      margin: 0 auto;
    }
    .snackbar.show { bottom: 10px; }
    .snackbar-undo-btn {
      background: transparent;
      border: 1px solid white;
      color: white;
      padding: 4px 12px;
      border-radius: 3px;
      font-size: 12px;
      margin-left: 10px;
      cursor: pointer;
      min-width: 44px;
      min-height: 30px;
    }
    .snackbar-info { background: #2563eb; }
    .snackbar-error { background: #dc2626; }
    .snackbar-success { background: #16a34a; }
  </style>
</head>
<body class="bg-gray-900 text-white p-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">Phase 1 테스트</h1>

    <div class="space-y-4">
      <!-- 테스트 플레이어 목록 -->
      <div class="bg-gray-800 p-4 rounded-lg">
        <h2 class="text-lg font-bold mb-3">플레이어 관리</h2>
        <div id="player-list" class="space-y-2"></div>
      </div>

      <!-- 테스트 버튼들 -->
      <div class="bg-gray-800 p-4 rounded-lg">
        <h2 class="text-lg font-bold mb-3">테스트 액션</h2>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="addTestPlayer()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
            플레이어 추가
          </button>
          <button onclick="deleteTestPlayer()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">
            플레이어 삭제
          </button>
          <button onclick="updateTestPlayer()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
            플레이어 수정
          </button>
          <button onclick="batchTest()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">
            일괄 작업
          </button>
          <button onclick="testUndo()" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded">
            실행 취소
          </button>
          <button onclick="clearHistory()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
            히스토리 초기화
          </button>
        </div>
      </div>

      <!-- 테스트 결과 -->
      <div class="bg-gray-800 p-4 rounded-lg">
        <h2 class="text-lg font-bold mb-3">테스트 결과</h2>
        <div id="test-results" class="space-y-2 text-sm font-mono">
          <div>✅ ActionHistory 시스템 로드됨</div>
        </div>
      </div>

      <!-- 히스토리 현황 -->
      <div class="bg-gray-800 p-4 rounded-lg">
        <h2 class="text-lg font-bold mb-3">히스토리 현황</h2>
        <div id="history-status" class="text-sm">
          히스토리 개수: <span id="history-count">0</span> / 20
        </div>
        <div id="history-list" class="mt-2 space-y-1 text-xs"></div>
      </div>
    </div>
  </div>

  <!-- 스낵바 -->
  <div id="snackbar" class="snackbar"></div>

  <script>
    // 테스트 데이터
    let testPlayers = [
      { id: 1, name: 'Player1', seat: 1, chips: 1000 },
      { id: 2, name: 'Player2', seat: 2, chips: 2000 },
      { id: 3, name: 'Player3', seat: 3, chips: 1500 }
    ];

    // Mock tableManager
    window.tableManager = {
      deletePlayer: async (name) => {
        testPlayers = testPlayers.filter(p => p.name !== name);
        renderPlayers();
        return true;
      },
      addPlayer: async (player) => {
        testPlayers.push(player);
        renderPlayers();
        return true;
      },
      updatePlayer: async (player) => {
        const index = testPlayers.findIndex(p => p.id === player.id);
        if (index >= 0) {
          testPlayers[index] = player;
          renderPlayers();
        }
        return true;
      }
    };

    // 플레이어 목록 렌더링
    function renderPlayers() {
      const list = document.getElementById('player-list');
      list.innerHTML = testPlayers.map(p => `
        <div class="flex justify-between items-center bg-gray-700 p-2 rounded">
          <span>${p.name} (Seat ${p.seat})</span>
          <span class="text-amber-400">${p.chips} chips</span>
        </div>
      `).join('');
      updateHistoryStatus();
    }

    // 히스토리 상태 업데이트
    function updateHistoryStatus() {
      const count = window.actionHistory.history.length;
      document.getElementById('history-count').textContent = count;

      const list = document.getElementById('history-list');
      list.innerHTML = window.actionHistory.history.map((action, i) => `
        <div class="text-gray-400">${i + 1}. ${action.getDescription()}</div>
      `).join('');
    }

    // 테스트 함수들
    async function addTestPlayer() {
      const num = testPlayers.length + 1;
      const newPlayer = {
        id: num,
        name: `Player${num}`,
        seat: num,
        chips: Math.floor(Math.random() * 5000) + 1000
      };

      const action = new AddPlayerAction(newPlayer);
      await window.actionHistory.execute(action);

      addResult('✅ 플레이어 추가 테스트 완료');
    }

    async function deleteTestPlayer() {
      if (testPlayers.length === 0) {
        window.actionHistory.showSnackbar('삭제할 플레이어가 없습니다', null, 'error');
        return;
      }

      const player = testPlayers[0];
      const action = new DeletePlayerAction(player);
      await window.actionHistory.execute(action);

      addResult('✅ 플레이어 삭제 테스트 완료');
    }

    async function updateTestPlayer() {
      if (testPlayers.length === 0) {
        window.actionHistory.showSnackbar('수정할 플레이어가 없습니다', null, 'error');
        return;
      }

      const oldPlayer = testPlayers[0];
      const newPlayer = { ...oldPlayer, chips: oldPlayer.chips + 500 };

      const action = new UpdatePlayerAction(oldPlayer, newPlayer);
      await window.actionHistory.execute(action);

      addResult('✅ 플레이어 수정 테스트 완료');
    }

    async function batchTest() {
      const actions = [
        new AddPlayerAction({ id: 99, name: 'BatchTest1', seat: 99, chips: 9999 }),
        new AddPlayerAction({ id: 100, name: 'BatchTest2', seat: 100, chips: 10000 })
      ];

      const batch = new BatchAction(actions, '2명 일괄 추가');
      await window.actionHistory.execute(batch);

      addResult('✅ 일괄 작업 테스트 완료');
    }

    async function testUndo() {
      await window.actionHistory.undo();
      addResult('✅ 실행 취소 테스트 완료');
    }

    function clearHistory() {
      window.actionHistory.clear();
      addResult('✅ 히스토리 초기화 완료');
    }

    function addResult(message) {
      const results = document.getElementById('test-results');
      const div = document.createElement('div');
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      results.appendChild(div);

      // 10개 이상이면 오래된 것 제거
      if (results.children.length > 10) {
        results.removeChild(results.firstChild);
      }
    }

    // 초기 렌더링
    renderPlayers();

    // 자동 테스트 시퀀스
    async function runAutoTest() {
      addResult('🚀 자동 테스트 시작...');

      await new Promise(r => setTimeout(r, 1000));
      await addTestPlayer();

      await new Promise(r => setTimeout(r, 1500));
      await deleteTestPlayer();

      await new Promise(r => setTimeout(r, 1500));
      await testUndo();

      addResult('✅ 자동 테스트 완료!');
    }

    // 5초 후 자동 테스트 실행
    setTimeout(runAutoTest, 5000);
  </script>
</body>
</html>