<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Test - Phase 4 Functions</title>
</head>
<body>
    <h1>Minimal Phase 4 Test</h1>
    <div id="test-result"></div>
    <button onclick="testPhase4Functions()">Test Phase 4 Functions</button>

    <script>
        console.log('ğŸš€ Minimal test script started');

        // APP_CONFIG ì •ì˜
        window.APP_CONFIG = {
            isInitialized: false,
            appsScriptUrl: null,
            autoInit: false,
            version: '3.4.26',
            data: {},
            settings: { debugMode: false, autoSave: true, offlineMode: false },
            state: { lastConnection: null, connectionAttempts: 0, isOnline: navigator.onLine }
        };

        // validateAppsScriptUrl í•¨ìˆ˜
        function validateAppsScriptUrl(url) {
            if (!url || typeof url !== 'string') return false;
            return /^https:\/\/script\.google\.com\/macros\/s\/[A-Za-z0-9_-]+\/exec$/.test(url);
        }

        // Phase 4 í•¨ìˆ˜ë“¤ ì •ì˜
        window.ensureAppsScriptUrl = function() {
            console.log('ensureAppsScriptUrl called');
            if (!window.APP_CONFIG.appsScriptUrl) {
                throw new Error('Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
            if (!validateAppsScriptUrl(window.APP_CONFIG.appsScriptUrl)) {
                throw new Error('ì˜¬ë°”ë¥´ì§€ ì•Šì€ Apps Script URLì…ë‹ˆë‹¤.');
            }
            if (!window.APP_CONFIG.isInitialized) {
                throw new Error('ì•±ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
            if (!window.APP_CONFIG.state.isOnline) {
                throw new Error('ì¸í„°ë„· ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
            }
            return window.APP_CONFIG.appsScriptUrl;
        };

        window.protectedApiCall = async function(action, data = {}, options = {}) {
            console.log('protectedApiCall called:', action, data, options);
            // í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ êµ¬í˜„
            return { success: true, action, data, options };
        };

        window.ApiCallManager = {
            calls: [],
            addCall: function(call) {
                this.calls.push(call);
                console.log('ApiCallManager.addCall:', call);
            },
            getStats: function() {
                return {
                    totalCalls: this.calls.length,
                    successCalls: this.calls.filter(c => c.success).length,
                    failedCalls: this.calls.filter(c => !c.success).length,
                    averageResponseTime: 100
                };
            },
            reset: function() {
                this.calls = [];
                console.log('ApiCallManager.reset');
            }
        };

        window.getUserFriendlyErrorMessage = function(error, action) {
            console.log('getUserFriendlyErrorMessage called:', error, action);
            const message = typeof error === 'string' ? error :
                           error && error.message ? error.message :
                           error ? error.toString() : 'Unknown error';

            if (message.includes('URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤')) {
                return 'âš ï¸ Apps Script URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.';
            }
            if (message.includes('ì˜¬ë°”ë¥´ì§€ ì•Šì€ Apps Script URL')) {
                return 'âš ï¸ ì˜¬ë°”ë¥¸ Apps Script URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            }
            if (message.includes('ì•±ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤')) {
                return 'âš ï¸ ì•± ì´ˆê¸°í™”ë¥¼ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.';
            }
            if (message.includes('ì¸í„°ë„· ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤')) {
                return 'âš ï¸ ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
            }

            return `âŒ ${action || 'ì‘ì—…'} ì‹¤íŒ¨: ${message}`;
        };

        // ì¶”ê°€ ë³´í˜¸ëœ í•¨ìˆ˜ë“¤
        window.protectedSendToSheets = async function() {
            console.log('protectedSendToSheets called');
            return await window.protectedApiCall('submitHand', {}, {
                showProgress: true,
                progressMessage: 'ë°ì´í„° ì „ì†¡ ì¤‘...',
                retryCount: 2
            });
        };

        window.protectedBulkRegister = async function(payload) {
            console.log('protectedBulkRegister called:', payload);
            return await window.protectedApiCall('batchUpdate', payload, {
                showProgress: true,
                progressMessage: 'ì¼ê´„ ë“±ë¡ ì¤‘...',
                retryCount: 2
            });
        };

        window.protectedAddPlayer = async function(playerData) {
            console.log('protectedAddPlayer called:', playerData);
            return await window.protectedApiCall('addPlayer', playerData, {
                showProgress: true,
                progressMessage: 'í”Œë ˆì´ì–´ ì¶”ê°€ ì¤‘...',
                retryCount: 2
            });
        };

        // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        function testPhase4Functions() {
            console.log('ğŸ§ª Phase 4 í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            const results = {
                APP_CONFIG: typeof window.APP_CONFIG,
                ensureAppsScriptUrl: typeof window.ensureAppsScriptUrl,
                protectedApiCall: typeof window.protectedApiCall,
                ApiCallManager: typeof window.ApiCallManager,
                getUserFriendlyErrorMessage: typeof window.getUserFriendlyErrorMessage,
                protectedSendToSheets: typeof window.protectedSendToSheets,
                protectedBulkRegister: typeof window.protectedBulkRegister,
                protectedAddPlayer: typeof window.protectedAddPlayer
            };

            console.log('ğŸ“Š í•¨ìˆ˜ ì •ì˜ ìƒíƒœ:', results);

            const resultDiv = document.getElementById('test-result');
            const allDefined = Object.values(results).every(type =>
                type === 'function' || type === 'object'
            );

            resultDiv.innerHTML = `
                <h3>í…ŒìŠ¤íŠ¸ ê²°ê³¼: ${allDefined ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'}</h3>
                <ul>
                    ${Object.entries(results).map(([name, type]) =>
                        `<li>${name}: ${type} ${type === 'function' || type === 'object' ? 'âœ…' : 'âŒ'}</li>`
                    ).join('')}
                </ul>
            `;

            // ì‹¤ì œ í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
            if (allDefined) {
                console.log('ğŸ¯ í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸...');

                // URL ê²€ì¦ í…ŒìŠ¤íŠ¸ (ì—ëŸ¬ ì˜ˆìƒ)
                try {
                    window.ensureAppsScriptUrl();
                } catch (error) {
                    console.log('âœ… URL ê²€ì¦ ì—ëŸ¬ ì •ìƒ ë™ì‘:', error.message);
                }

                // ì—ëŸ¬ ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸
                const errorMsg = window.getUserFriendlyErrorMessage('URL_VALIDATION_ERROR', 'testAction');
                console.log('âœ… ì—ëŸ¬ ë©”ì‹œì§€ ìƒì„±:', errorMsg);

                // API Call Manager í…ŒìŠ¤íŠ¸
                window.ApiCallManager.addCall({ action: 'test', success: true });
                const stats = window.ApiCallManager.getStats();
                console.log('âœ… API Call Manager í†µê³„:', stats);
            }

            return allDefined;
        }

        // í˜ì´ì§€ ë¡œë“œ í›„ ìë™ í…ŒìŠ¤íŠ¸
        window.addEventListener('load', function() {
            console.log('âœ… í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            setTimeout(testPhase4Functions, 100);
        });

        console.log('âœ… Minimal test script completed');
    </script>
</body>
</html>