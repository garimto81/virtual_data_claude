<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4 Testing - API 호출 보호 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">🔒 Phase 4: API 호출 보호 시스템 테스트</h1>

        <!-- Apps Script URL 설정 -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6">
            <h2 class="text-xl font-semibold mb-4">📋 Apps Script URL 설정</h2>
            <div class="mb-4">
                <label class="block mb-2">Apps Script URL:</label>
                <input type="text" id="appsScriptUrl"
                       class="w-full p-2 bg-gray-700 rounded border"
                       placeholder="https://script.google.com/macros/s/.../exec">
                <button onclick="setAppsScriptUrl()"
                        class="mt-2 bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">
                    URL 설정
                </button>
            </div>
            <div id="urlStatus" class="text-sm"></div>
        </div>

        <!-- 테스트 섹션들 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- URL 검증 테스트 -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">🔍 URL 검증 테스트</h3>
                <button onclick="testUrlValidation()"
                        class="bg-green-600 px-4 py-2 rounded hover:bg-green-700 mb-2">
                    URL 검증 실행
                </button>
                <div id="urlValidationResult" class="text-sm bg-gray-700 p-2 rounded"></div>
            </div>

            <!-- 보호된 API 호출 테스트 -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibent mb-3">🛡️ 보호된 API 호출 테스트</h3>
                <button onclick="testProtectedApiCall()"
                        class="bg-purple-600 px-4 py-2 rounded hover:bg-purple-700 mb-2">
                    보호된 호출 테스트
                </button>
                <div id="protectedCallResult" class="text-sm bg-gray-700 p-2 rounded"></div>
            </div>

            <!-- sendDataToGoogleSheet 테스트 -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">📤 데이터 전송 테스트</h3>
                <button onclick="testSendDataToGoogleSheet()"
                        class="bg-orange-600 px-4 py-2 rounded hover:bg-orange-700 mb-2">
                    데이터 전송 테스트
                </button>
                <div id="sendDataResult" class="text-sm bg-gray-700 p-2 rounded"></div>
            </div>

            <!-- 플레이어 관리 함수 테스트 -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">👥 플레이어 관리 테스트</h3>
                <button onclick="testPlayerManagement()"
                        class="bg-red-600 px-4 py-2 rounded hover:bg-red-700 mb-2">
                    플레이어 관리 테스트
                </button>
                <div id="playerManagementResult" class="text-sm bg-gray-700 p-2 rounded"></div>
            </div>

            <!-- 에러 처리 테스트 -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">⚠️ 에러 처리 테스트</h3>
                <button onclick="testErrorHandling()"
                        class="bg-yellow-600 px-4 py-2 rounded hover:bg-yellow-700 mb-2">
                    에러 처리 테스트
                </button>
                <div id="errorHandlingResult" class="text-sm bg-gray-700 p-2 rounded"></div>
            </div>

            <!-- API 호출 통계 -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">📊 API 호출 통계</h3>
                <button onclick="showApiStats()"
                        class="bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-700 mb-2">
                    통계 보기
                </button>
                <div id="apiStatsResult" class="text-sm bg-gray-700 p-2 rounded"></div>
            </div>
        </div>

        <!-- 전체 로그 -->
        <div class="bg-gray-800 p-4 rounded-lg mt-6">
            <h3 class="text-lg font-semibold mb-3">📝 테스트 로그</h3>
            <div id="testLog" class="bg-black p-4 rounded text-green-400 font-mono text-sm h-64 overflow-y-auto"></div>
            <button onclick="clearLog()"
                    class="mt-2 bg-gray-600 px-4 py-2 rounded hover:bg-gray-700">
                로그 지우기
            </button>
        </div>
    </div>

    <script>
        // 로그 함수
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-400' :
                             type === 'success' ? 'text-green-400' :
                             type === 'warning' ? 'text-yellow-400' : 'text-blue-400';

            logDiv.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        // Apps Script URL 설정
        function setAppsScriptUrl() {
            const url = document.getElementById('appsScriptUrl').value.trim();
            const statusDiv = document.getElementById('urlStatus');

            if (!url) {
                statusDiv.innerHTML = '<span class="text-red-400">❌ URL을 입력해주세요</span>';
                return;
            }

            try {
                // 간단한 URL 형식 검증
                new URL(url);

                // localStorage에 저장
                localStorage.setItem('pokerHandLogger_appsScriptUrl', url);

                statusDiv.innerHTML = '<span class="text-green-400">✅ URL이 설정되었습니다</span>';
                log(`Apps Script URL 설정됨: ${url}`, 'success');

                // window.APP_CONFIG 업데이트 (만약 존재한다면)
                if (window.APP_CONFIG) {
                    window.APP_CONFIG.appsScriptUrl = url;
                    window.APP_CONFIG.isInitialized = true;
                }

            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-400">❌ 올바른 URL 형식이 아닙니다</span>';
                log(`URL 설정 실패: ${error.message}`, 'error');
            }
        }

        // URL 검증 테스트
        async function testUrlValidation() {
            const resultDiv = document.getElementById('urlValidationResult');
            log('URL 검증 테스트 시작', 'info');

            try {
                // Phase 4 보호 함수들이 정의되었는지 확인
                if (typeof ensureAppsScriptUrl === 'undefined') {
                    throw new Error('ensureAppsScriptUrl 함수가 정의되지 않았습니다');
                }

                // URL 검증 실행
                ensureAppsScriptUrl();
                resultDiv.innerHTML = '<span class="text-green-400">✅ URL 검증 성공</span>';
                log('URL 검증 성공', 'success');

            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-400">❌ ${error.message}</span>`;
                log(`URL 검증 실패: ${error.message}`, 'error');
            }
        }

        // 보호된 API 호출 테스트
        async function testProtectedApiCall() {
            const resultDiv = document.getElementById('protectedCallResult');
            log('보호된 API 호출 테스트 시작', 'info');

            try {
                if (typeof protectedApiCall === 'undefined') {
                    throw new Error('protectedApiCall 함수가 정의되지 않았습니다');
                }

                // 테스트용 더미 페이로드
                const testPayload = { test: true, message: 'Phase 4 테스트' };

                log('보호된 API 호출 실행 중...', 'info');
                const result = await protectedApiCall('getConfig', testPayload, {
                    showProgress: false,
                    progressMessage: '테스트 호출 중...',
                    retryCount: 1
                });

                resultDiv.innerHTML = '<span class="text-green-400">✅ 보호된 API 호출 테스트 완료</span>';
                log(`보호된 API 호출 결과: ${JSON.stringify(result)}`, 'success');

            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-400">❌ ${error.message}</span>`;
                log(`보호된 API 호출 실패: ${error.message}`, 'error');
            }
        }

        // 데이터 전송 테스트
        async function testSendDataToGoogleSheet() {
            const resultDiv = document.getElementById('sendDataResult');
            log('데이터 전송 테스트 시작', 'info');

            try {
                if (typeof sendDataToGoogleSheet === 'undefined') {
                    throw new Error('sendDataToGoogleSheet 함수가 정의되지 않았습니다');
                }

                // 테스트는 실제 실행하지 않고 함수 존재만 확인
                resultDiv.innerHTML = '<span class="text-green-400">✅ sendDataToGoogleSheet 함수 확인됨</span>';
                log('데이터 전송 함수 확인 완료 (실제 전송은 실행하지 않음)', 'success');

            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-400">❌ ${error.message}</span>`;
                log(`데이터 전송 테스트 실패: ${error.message}`, 'error');
            }
        }

        // 플레이어 관리 테스트
        async function testPlayerManagement() {
            const resultDiv = document.getElementById('playerManagementResult');
            log('플레이어 관리 함수 테스트 시작', 'info');

            const functions = ['addNewPlayer', 'updatePlayerSeat', 'updatePlayerChips'];
            let allExists = true;
            let results = [];

            for (const funcName of functions) {
                if (typeof window[funcName] === 'undefined') {
                    results.push(`❌ ${funcName}: 정의되지 않음`);
                    allExists = false;
                } else {
                    results.push(`✅ ${funcName}: 확인됨`);
                }
            }

            resultDiv.innerHTML = results.join('<br>');

            if (allExists) {
                log('모든 플레이어 관리 함수 확인됨', 'success');
            } else {
                log('일부 플레이어 관리 함수가 누락됨', 'warning');
            }
        }

        // 에러 처리 테스트
        async function testErrorHandling() {
            const resultDiv = document.getElementById('errorHandlingResult');
            log('에러 처리 테스트 시작', 'info');

            try {
                if (typeof getUserFriendlyErrorMessage === 'undefined') {
                    throw new Error('getUserFriendlyErrorMessage 함수가 정의되지 않았습니다');
                }

                // 여러 에러 타입 테스트
                const errorTypes = ['URL_VALIDATION_ERROR', 'NETWORK_ERROR', 'API_ERROR', 'UNKNOWN_ERROR'];
                const messages = errorTypes.map(type => {
                    const msg = getUserFriendlyErrorMessage(type);
                    return `${type}: "${msg}"`;
                });

                resultDiv.innerHTML = messages.join('<br>');
                log('에러 메시지 함수 테스트 완료', 'success');

            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-400">❌ ${error.message}</span>`;
                log(`에러 처리 테스트 실패: ${error.message}`, 'error');
            }
        }

        // API 호출 통계
        function showApiStats() {
            const resultDiv = document.getElementById('apiStatsResult');
            log('API 호출 통계 확인', 'info');

            if (typeof ApiCallManager !== 'undefined' && ApiCallManager.getStats) {
                const stats = ApiCallManager.getStats();
                resultDiv.innerHTML = `
                    총 호출: ${stats.totalCalls || 0}<br>
                    성공: ${stats.successCalls || 0}<br>
                    실패: ${stats.failedCalls || 0}<br>
                    평균 응답시간: ${stats.averageResponseTime || 0}ms
                `;
                log('API 통계 표시 완료', 'success');
            } else {
                resultDiv.innerHTML = '<span class="text-red-400">❌ ApiCallManager 클래스가 정의되지 않았습니다</span>';
                log('ApiCallManager 클래스가 누락됨', 'error');
            }
        }

        // 페이지 로드 시 초기 설정
        window.addEventListener('load', function() {
            log('Phase 4 테스트 페이지 로드됨', 'info');

            // localStorage에서 기존 URL 복원
            const savedUrl = localStorage.getItem('pokerHandLogger_appsScriptUrl');
            if (savedUrl) {
                document.getElementById('appsScriptUrl').value = savedUrl;
                document.getElementById('urlStatus').innerHTML =
                    '<span class="text-blue-400">💾 저장된 URL이 복원되었습니다</span>';
                log(`저장된 URL 복원: ${savedUrl}`, 'info');
            }
        });
    </script>
</body>
</html>