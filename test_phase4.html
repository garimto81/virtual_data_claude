<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4 Testing - API í˜¸ì¶œ ë³´í˜¸ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">ğŸ”’ Phase 4: API í˜¸ì¶œ ë³´í˜¸ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>

        <!-- Apps Script URL ì„¤ì • -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ Apps Script URL ì„¤ì •</h2>
            <div class="mb-4">
                <label class="block mb-2">Apps Script URL:</label>
                <input type="text" id="appsScriptUrl"
                       class="w-full p-2 bg-gray-700 rounded border"
                       placeholder="https://script.google.com/macros/s/.../exec">
                <button onclick="setAppsScriptUrl()"
                        class="mt-2 bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">
                    URL ì„¤ì •
                </button>
            </div>
            <div id="urlStatus" class="text-sm"></div>
        </div>

        <!-- í…ŒìŠ¤íŠ¸ ì„¹ì…˜ë“¤ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- URL ê²€ì¦ í…ŒìŠ¤íŠ¸ -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">ğŸ” URL ê²€ì¦ í…ŒìŠ¤íŠ¸</h3>
                <button onclick="testUrlValidation()"
                        class="bg-green-600 px-4 py-2 rounded hover:bg-green-700 mb-2">
                    URL ê²€ì¦ ì‹¤í–‰
                </button>
                <div id="urlValidationResult" class="text-sm bg-gray-700 p-2 rounded"></div>
            </div>

            <!-- ë³´í˜¸ëœ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸ -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibent mb-3">ğŸ›¡ï¸ ë³´í˜¸ëœ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸</h3>
                <button onclick="testProtectedApiCall()"
                        class="bg-purple-600 px-4 py-2 rounded hover:bg-purple-700 mb-2">
                    ë³´í˜¸ëœ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
                </button>
                <div id="protectedCallResult" class="text-sm bg-gray-700 p-2 rounded"></div>
            </div>

            <!-- sendDataToGoogleSheet í…ŒìŠ¤íŠ¸ -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">ğŸ“¤ ë°ì´í„° ì „ì†¡ í…ŒìŠ¤íŠ¸</h3>
                <button onclick="testSendDataToGoogleSheet()"
                        class="bg-orange-600 px-4 py-2 rounded hover:bg-orange-700 mb-2">
                    ë°ì´í„° ì „ì†¡ í…ŒìŠ¤íŠ¸
                </button>
                <div id="sendDataResult" class="text-sm bg-gray-700 p-2 rounded"></div>
            </div>

            <!-- í”Œë ˆì´ì–´ ê´€ë¦¬ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">ğŸ‘¥ í”Œë ˆì´ì–´ ê´€ë¦¬ í…ŒìŠ¤íŠ¸</h3>
                <button onclick="testPlayerManagement()"
                        class="bg-red-600 px-4 py-2 rounded hover:bg-red-700 mb-2">
                    í”Œë ˆì´ì–´ ê´€ë¦¬ í…ŒìŠ¤íŠ¸
                </button>
                <div id="playerManagementResult" class="text-sm bg-gray-700 p-2 rounded"></div>
            </div>

            <!-- ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">âš ï¸ ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸</h3>
                <button onclick="testErrorHandling()"
                        class="bg-yellow-600 px-4 py-2 rounded hover:bg-yellow-700 mb-2">
                    ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
                </button>
                <div id="errorHandlingResult" class="text-sm bg-gray-700 p-2 rounded"></div>
            </div>

            <!-- API í˜¸ì¶œ í†µê³„ -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">ğŸ“Š API í˜¸ì¶œ í†µê³„</h3>
                <button onclick="showApiStats()"
                        class="bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-700 mb-2">
                    í†µê³„ ë³´ê¸°
                </button>
                <div id="apiStatsResult" class="text-sm bg-gray-700 p-2 rounded"></div>
            </div>
        </div>

        <!-- ì „ì²´ ë¡œê·¸ -->
        <div class="bg-gray-800 p-4 rounded-lg mt-6">
            <h3 class="text-lg font-semibold mb-3">ğŸ“ í…ŒìŠ¤íŠ¸ ë¡œê·¸</h3>
            <div id="testLog" class="bg-black p-4 rounded text-green-400 font-mono text-sm h-64 overflow-y-auto"></div>
            <button onclick="clearLog()"
                    class="mt-2 bg-gray-600 px-4 py-2 rounded hover:bg-gray-700">
                ë¡œê·¸ ì§€ìš°ê¸°
            </button>
        </div>
    </div>

    <script>
        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-400' :
                             type === 'success' ? 'text-green-400' :
                             type === 'warning' ? 'text-yellow-400' : 'text-blue-400';

            logDiv.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        // Apps Script URL ì„¤ì •
        function setAppsScriptUrl() {
            const url = document.getElementById('appsScriptUrl').value.trim();
            const statusDiv = document.getElementById('urlStatus');

            if (!url) {
                statusDiv.innerHTML = '<span class="text-red-400">âŒ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”</span>';
                return;
            }

            try {
                // ê°„ë‹¨í•œ URL í˜•ì‹ ê²€ì¦
                new URL(url);

                // localStorageì— ì €ì¥
                localStorage.setItem('pokerHandLogger_appsScriptUrl', url);

                statusDiv.innerHTML = '<span class="text-green-400">âœ… URLì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤</span>';
                log(`Apps Script URL ì„¤ì •ë¨: ${url}`, 'success');

                // window.APP_CONFIG ì—…ë°ì´íŠ¸ (ë§Œì•½ ì¡´ì¬í•œë‹¤ë©´)
                if (window.APP_CONFIG) {
                    window.APP_CONFIG.appsScriptUrl = url;
                    window.APP_CONFIG.isInitialized = true;
                }

            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-400">âŒ ì˜¬ë°”ë¥¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤</span>';
                log(`URL ì„¤ì • ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // URL ê²€ì¦ í…ŒìŠ¤íŠ¸
        async function testUrlValidation() {
            const resultDiv = document.getElementById('urlValidationResult');
            log('URL ê²€ì¦ í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info');

            try {
                // Phase 4 ë³´í˜¸ í•¨ìˆ˜ë“¤ì´ ì •ì˜ë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (typeof ensureAppsScriptUrl === 'undefined') {
                    throw new Error('ensureAppsScriptUrl í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                }

                // URL ê²€ì¦ ì‹¤í–‰
                ensureAppsScriptUrl();
                resultDiv.innerHTML = '<span class="text-green-400">âœ… URL ê²€ì¦ ì„±ê³µ</span>';
                log('URL ê²€ì¦ ì„±ê³µ', 'success');

            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-400">âŒ ${error.message}</span>`;
                log(`URL ê²€ì¦ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ë³´í˜¸ëœ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸
        async function testProtectedApiCall() {
            const resultDiv = document.getElementById('protectedCallResult');
            log('ë³´í˜¸ëœ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info');

            try {
                if (typeof protectedApiCall === 'undefined') {
                    throw new Error('protectedApiCall í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                }

                // í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ í˜ì´ë¡œë“œ
                const testPayload = { test: true, message: 'Phase 4 í…ŒìŠ¤íŠ¸' };

                log('ë³´í˜¸ëœ API í˜¸ì¶œ ì‹¤í–‰ ì¤‘...', 'info');
                const result = await protectedApiCall('getConfig', testPayload, {
                    showProgress: false,
                    progressMessage: 'í…ŒìŠ¤íŠ¸ í˜¸ì¶œ ì¤‘...',
                    retryCount: 1
                });

                resultDiv.innerHTML = '<span class="text-green-400">âœ… ë³´í˜¸ëœ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ</span>';
                log(`ë³´í˜¸ëœ API í˜¸ì¶œ ê²°ê³¼: ${JSON.stringify(result)}`, 'success');

            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-400">âŒ ${error.message}</span>`;
                log(`ë³´í˜¸ëœ API í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ë°ì´í„° ì „ì†¡ í…ŒìŠ¤íŠ¸
        async function testSendDataToGoogleSheet() {
            const resultDiv = document.getElementById('sendDataResult');
            log('ë°ì´í„° ì „ì†¡ í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info');

            try {
                if (typeof sendDataToGoogleSheet === 'undefined') {
                    throw new Error('sendDataToGoogleSheet í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                }

                // í…ŒìŠ¤íŠ¸ëŠ” ì‹¤ì œ ì‹¤í–‰í•˜ì§€ ì•Šê³  í•¨ìˆ˜ ì¡´ì¬ë§Œ í™•ì¸
                resultDiv.innerHTML = '<span class="text-green-400">âœ… sendDataToGoogleSheet í•¨ìˆ˜ í™•ì¸ë¨</span>';
                log('ë°ì´í„° ì „ì†¡ í•¨ìˆ˜ í™•ì¸ ì™„ë£Œ (ì‹¤ì œ ì „ì†¡ì€ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ)', 'success');

            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-400">âŒ ${error.message}</span>`;
                log(`ë°ì´í„° ì „ì†¡ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // í”Œë ˆì´ì–´ ê´€ë¦¬ í…ŒìŠ¤íŠ¸
        async function testPlayerManagement() {
            const resultDiv = document.getElementById('playerManagementResult');
            log('í”Œë ˆì´ì–´ ê´€ë¦¬ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info');

            const functions = ['addNewPlayer', 'updatePlayerSeat', 'updatePlayerChips'];
            let allExists = true;
            let results = [];

            for (const funcName of functions) {
                if (typeof window[funcName] === 'undefined') {
                    results.push(`âŒ ${funcName}: ì •ì˜ë˜ì§€ ì•ŠìŒ`);
                    allExists = false;
                } else {
                    results.push(`âœ… ${funcName}: í™•ì¸ë¨`);
                }
            }

            resultDiv.innerHTML = results.join('<br>');

            if (allExists) {
                log('ëª¨ë“  í”Œë ˆì´ì–´ ê´€ë¦¬ í•¨ìˆ˜ í™•ì¸ë¨', 'success');
            } else {
                log('ì¼ë¶€ í”Œë ˆì´ì–´ ê´€ë¦¬ í•¨ìˆ˜ê°€ ëˆ„ë½ë¨', 'warning');
            }
        }

        // ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
        async function testErrorHandling() {
            const resultDiv = document.getElementById('errorHandlingResult');
            log('ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info');

            try {
                if (typeof getUserFriendlyErrorMessage === 'undefined') {
                    throw new Error('getUserFriendlyErrorMessage í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                }

                // ì—¬ëŸ¬ ì—ëŸ¬ íƒ€ì… í…ŒìŠ¤íŠ¸
                const errorTypes = ['URL_VALIDATION_ERROR', 'NETWORK_ERROR', 'API_ERROR', 'UNKNOWN_ERROR'];
                const messages = errorTypes.map(type => {
                    const msg = getUserFriendlyErrorMessage(type);
                    return `${type}: "${msg}"`;
                });

                resultDiv.innerHTML = messages.join('<br>');
                log('ì—ëŸ¬ ë©”ì‹œì§€ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ', 'success');

            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-400">âŒ ${error.message}</span>`;
                log(`ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // API í˜¸ì¶œ í†µê³„
        function showApiStats() {
            const resultDiv = document.getElementById('apiStatsResult');
            log('API í˜¸ì¶œ í†µê³„ í™•ì¸', 'info');

            if (typeof ApiCallManager !== 'undefined' && ApiCallManager.getStats) {
                const stats = ApiCallManager.getStats();
                resultDiv.innerHTML = `
                    ì´ í˜¸ì¶œ: ${stats.totalCalls || 0}<br>
                    ì„±ê³µ: ${stats.successCalls || 0}<br>
                    ì‹¤íŒ¨: ${stats.failedCalls || 0}<br>
                    í‰ê·  ì‘ë‹µì‹œê°„: ${stats.averageResponseTime || 0}ms
                `;
                log('API í†µê³„ í‘œì‹œ ì™„ë£Œ', 'success');
            } else {
                resultDiv.innerHTML = '<span class="text-red-400">âŒ ApiCallManager í´ë˜ìŠ¤ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</span>';
                log('ApiCallManager í´ë˜ìŠ¤ê°€ ëˆ„ë½ë¨', 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì„¤ì •
        window.addEventListener('load', function() {
            log('Phase 4 í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨', 'info');

            // localStorageì—ì„œ ê¸°ì¡´ URL ë³µì›
            const savedUrl = localStorage.getItem('pokerHandLogger_appsScriptUrl');
            if (savedUrl) {
                document.getElementById('appsScriptUrl').value = savedUrl;
                document.getElementById('urlStatus').innerHTML =
                    '<span class="text-blue-400">ğŸ’¾ ì €ì¥ëœ URLì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤</span>';
                log(`ì €ì¥ëœ URL ë³µì›: ${savedUrl}`, 'info');
            }
        });
    </script>
</body>
</html>